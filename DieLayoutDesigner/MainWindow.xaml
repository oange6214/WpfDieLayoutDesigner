<Window
    x:Class="DieLayoutDesigner.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:behaviors="clr-namespace:DieLayoutDesigner.Behaviors"
    xmlns:controls="clr-namespace:DieLayoutDesigner.Controls"
    xmlns:converters="clr-namespace:DieLayoutDesigner.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:local="clr-namespace:DieLayoutDesigner"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="clr-namespace:DieLayoutDesigner.Models"
    xmlns:vm="clr-namespace:DieLayoutDesigner.ViewModels"
    Title="Dual Canvas"
    Width="800"
    Height="500"
    d:DataContext="{d:DesignInstance vm:MainWindowViewModel}"
    mc:Ignorable="d">

    <Window.InputBindings>
        <KeyBinding
            Key="Delete"
            Command="{Binding DeleteCommand}" />
        <KeyBinding
            Key="Escape"
            Command="{Binding CancelCommand}" />
        <KeyBinding
            Key="A"
            Command="{Binding SelectAllCommand}"
            Modifiers="Control" />
        <KeyBinding
            Key="Left"
            Command="{Binding MoveCommand}"
            CommandParameter="Left" />
        <KeyBinding
            Key="Right"
            Command="{Binding MoveCommand}"
            CommandParameter="Right" />
        <KeyBinding
            Key="Up"
            Command="{Binding MoveCommand}"
            CommandParameter="Up" />
        <KeyBinding
            Key="Down"
            Command="{Binding MoveCommand}"
            CommandParameter="Down" />
    </Window.InputBindings>

    <Window.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <TabControl>
            <TabItem
                x:Name="Tab1"
                Header="Canvas 1">

                <DockPanel>
                    <TextBlock
                        Margin="5"
                        DockPanel.Dock="Top"
                        Text="{Binding StatusText}" />
                    <!--  綁定到 ViewModel 的狀態文字  -->
                    <Canvas
                        x:Name="DrawingCanvas"
                        Background="Transparent">

                        <i:Interaction.Behaviors>
                            <behaviors:MousePositionBehavior
                                MouseDownCommand="{Binding StartDrawingCommand}"
                                MouseMoveCommand="{Binding DrawingCommand}"
                                MouseUpCommand="{Binding EndDrawingCommand}" />
                        </i:Interaction.Behaviors>

                        <Rectangle
                            Width="{Binding ActualWidth, ElementName=DrawingCanvas}"
                            Height="{Binding ActualHeight, ElementName=DrawingCanvas}"
                            Cursor="Cross"
                            Fill="Transparent">
                            <i:Interaction.Behaviors>
                                <behaviors:MouseBehavior MouseDownCommand="{Binding CanvasClickCommand}" />
                            </i:Interaction.Behaviors>
                        </Rectangle>

                        <!--  Shapes  -->
                        <ItemsControl
                            Panel.ZIndex="1"
                            ItemsSource="{Binding Shapes}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <Canvas />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemContainerStyle>
                                <Style TargetType="ContentPresenter">
                                    <Setter Property="Canvas.Left" Value="{Binding TopLeft.X}" />
                                    <Setter Property="Canvas.Top" Value="{Binding TopLeft.Y}" />
                                </Style>
                            </ItemsControl.ItemContainerStyle>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <controls:SelectableRectangle>
                                        <controls:SelectableRectangle.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem
                                                    Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    Header="刪除" />
                                                <MenuItem
                                                    Command="{Binding DataContext.CopyCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    Header="複製" />
                                                <MenuItem
                                                    Command="{Binding DataContext.BringToFrontCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    Header="移到最上層" />
                                                <MenuItem
                                                    Command="{Binding DataContext.SendToBackCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    Header="移到最下層" />
                                            </ContextMenu>
                                        </controls:SelectableRectangle.ContextMenu>
                                    </controls:SelectableRectangle>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!--  Preview with dashed stroke  -->
                        <Rectangle
                            Canvas.Left="{Binding PreviewShape.TopLeft.X}"
                            Canvas.Top="{Binding PreviewShape.TopLeft.Y}"
                            Width="{Binding PreviewShape.DieSize.Width}"
                            Height="{Binding PreviewShape.DieSize.Height}"
                            Panel.ZIndex="2"
                            Fill="{Binding PreviewShape.FillColor}"
                            Stroke="Black"
                            StrokeDashArray="2,2"
                            Visibility="{Binding PreviewShape, Converter={StaticResource NullToVisibilityConverter}}" />
                    </Canvas>
                </DockPanel>

            </TabItem>

            <TabItem
                x:Name="Tab2"
                Header="Canvas 2">
                <ItemsControl ItemsSource="{Binding Shapes}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding TopLeft.X}" />
                            <Setter Property="Canvas.Top" Value="{Binding TopLeft.Y}" />
                        </Style>
                    </ItemsControl.ItemContainerStyle>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <controls:SelectableRectangle />
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </TabItem>
        </TabControl>


    </Grid>
</Window>
